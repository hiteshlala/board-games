<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/icon.png" />
    <link rel="stylesheet" href="/normalize.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shogi or Go</title>
    <style>
      .shogi-board {
        border: 2px solid brown;
        width: fit-content;
        background-color: burlywood;
      }
      .shogi-row {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
      }
      .shogi-row div {
        width: 52px;
        height: 52px;
        border: 1px solid brown;
        flex-grow: 0;
        flex-shrink: 0;
      }
      .shogi-piece {
        width: 52px;
        height: 52px;
        /* background: no-repeat center /80% url('shogipiece.png'); */
        line-height: 52px;
        text-align: center;
        border: none !important;
      }
      .upsidedown {
        transform: rotate(180deg);
      }
      .large {
        background: no-repeat center url('/shogipiece.png');
      }
      .medium {
        background: no-repeat center /80% url('/shogipiece.png');
      }
      .small {
        background: no-repeat center /70% url('/shogipiece.png');
      }
      .teal {
        color:teal
      }
      .violet {
        color:violet
      }
      .hide {
        display: none;
      }
      #chats {
        width: 100%;
        height: 60px;
        overflow-y: scroll;
        border-bottom: 1px solid orangered;
      }
      #chats p {
        padding: 3px;
        margin: 0px;
        font-size: 10px;
      }
      textarea {
        resize: none;
        width: 486px;
        border: none;
        border-color: transparent;
        padding: 0px;
        margin: 0px 5px;
        box-sizing: border-box;
        outline:none;
      }
      textarea:focus{
        outline: none;
      }
      .chatarea {
        background:seashell;
        border-radius: 3px;
        border: 2px solid orangered;
      }
      .warn {
        padding: 0px;
        margin: 0px;
        font-size: 10px;
        color: red;
      }
    </style>
  </head>
  <body>
    <header onclick="window.location.assign('/')">
      <img src="/icon.png">
      <img src="/go-icon.png">
      <p> Shogi or Go</p>
      <img src="/go-icon.png">
      <img src="/icon.png">
    </header>
    <div class="content">

      <div>
        <h4>
          <span>Shogi game between</span>
          <span id="p1"></span>
          <span>and</span>
          <span id="p2"></span>
        </ol>
      </div>
    
      <div class="shogi-board" id="board">
        <div class="shogi-row">
          <div class="shogi-square" data-y="0" data-x="0"></div>
          <div class="shogi-square" data-y="0" data-x="1"></div>
          <div class="shogi-square" data-y="0" data-x="2"></div>
          <div class="shogi-square" data-y="0" data-x="3"></div>
          <div class="shogi-square" data-y="0" data-x="4"></div>
          <div class="shogi-square" data-y="0" data-x="5"></div>
          <div class="shogi-square" data-y="0" data-x="6"></div>
          <div class="shogi-square" data-y="0" data-x="7"></div>
          <div class="shogi-square" data-y="0" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="1" data-x="0"></div>
          <div class="shogi-square" data-y="1" data-x="1"></div>
          <div class="shogi-square" data-y="1" data-x="2"></div>
          <div class="shogi-square" data-y="1" data-x="3"></div>
          <div class="shogi-square" data-y="1" data-x="4"></div>
          <div class="shogi-square" data-y="1" data-x="5"></div>
          <div class="shogi-square" data-y="1" data-x="6"></div>
          <div class="shogi-square" data-y="1" data-x="7"></div>
          <div class="shogi-square" data-y="1" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="2" data-x="0"></div>
          <div class="shogi-square" data-y="2" data-x="1"></div>
          <div class="shogi-square" data-y="2" data-x="2"></div>
          <div class="shogi-square" data-y="2" data-x="3"></div>
          <div class="shogi-square" data-y="2" data-x="4"></div>
          <div class="shogi-square" data-y="2" data-x="5"></div>
          <div class="shogi-square" data-y="2" data-x="6"></div>
          <div class="shogi-square" data-y="2" data-x="7"></div>
          <div class="shogi-square" data-y="2" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="3" data-x="0"></div>
          <div class="shogi-square" data-y="3" data-x="1"></div>
          <div class="shogi-square" data-y="3" data-x="2"></div>
          <div class="shogi-square" data-y="3" data-x="3"></div>
          <div class="shogi-square" data-y="3" data-x="4"></div>
          <div class="shogi-square" data-y="3" data-x="5"></div>
          <div class="shogi-square" data-y="3" data-x="6"></div>
          <div class="shogi-square" data-y="3" data-x="7"></div>
          <div class="shogi-square" data-y="3" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="4" data-x="0"></div>
          <div class="shogi-square" data-y="4" data-x="1"></div>
          <div class="shogi-square" data-y="4" data-x="2"></div>
          <div class="shogi-square" data-y="4" data-x="3"></div>
          <div class="shogi-square" data-y="4" data-x="4"></div>
          <div class="shogi-square" data-y="4" data-x="5"></div>
          <div class="shogi-square" data-y="4" data-x="6"></div>
          <div class="shogi-square" data-y="4" data-x="7"></div>
          <div class="shogi-square" data-y="4" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="5" data-x="0"></div>
          <div class="shogi-square" data-y="5" data-x="1"></div>
          <div class="shogi-square" data-y="5" data-x="2"></div>
          <div class="shogi-square" data-y="5" data-x="3"></div>
          <div class="shogi-square" data-y="5" data-x="4"></div>
          <div class="shogi-square" data-y="5" data-x="5"></div>
          <div class="shogi-square" data-y="5" data-x="6"></div>
          <div class="shogi-square" data-y="5" data-x="7"></div>
          <div class="shogi-square" data-y="5" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="6" data-x="0"></div>
          <div class="shogi-square" data-y="6" data-x="1"></div>
          <div class="shogi-square" data-y="6" data-x="2"></div>
          <div class="shogi-square" data-y="6" data-x="3"></div>
          <div class="shogi-square" data-y="6" data-x="4"></div>
          <div class="shogi-square" data-y="6" data-x="5"></div>
          <div class="shogi-square" data-y="6" data-x="6"></div>
          <div class="shogi-square" data-y="6" data-x="7"></div>
          <div class="shogi-square" data-y="6" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="7" data-x="0"></div>
          <div class="shogi-square" data-y="7" data-x="1"></div>
          <div class="shogi-square" data-y="7" data-x="2"></div>
          <div class="shogi-square" data-y="7" data-x="3"></div>
          <div class="shogi-square" data-y="7" data-x="4"></div>
          <div class="shogi-square" data-y="7" data-x="5"></div>
          <div class="shogi-square" data-y="7" data-x="6"></div>
          <div class="shogi-square" data-y="7" data-x="7"></div>
          <div class="shogi-square" data-y="7" data-x="8"></div>
        </div>
        <div class="shogi-row">
          <div class="shogi-square" data-y="8" data-x="0"></div>
          <div class="shogi-square" data-y="8" data-x="1"></div>
          <div class="shogi-square" data-y="8" data-x="2"></div>
          <div class="shogi-square" data-y="8" data-x="3"></div>
          <div class="shogi-square" data-y="8" data-x="4"></div>
          <div class="shogi-square" data-y="8" data-x="5"></div>
          <div class="shogi-square" data-y="8" data-x="6"></div>
          <div class="shogi-square" data-y="8" data-x="7"></div>
          <div class="shogi-square" data-y="8" data-x="8"></div>
        </div>
      </div>

      <div>
        <p>Shift click token to promote.</p>
        <p>
          <a href="https://en.wikipedia.org/wiki/Shogi" target="_blank" rel="noreferrer noopener">
            Click here for game play rules.
          </a>
        </p>
      </div>

      <div>
        <h4><span id="p1capname"></span> Captures</h4>
        <div id="player1Captures" class="rowlist"></div>
      </div>

      <div>
        <h4><span id="p2capname"></span> Captures</h4>
        <div id="player2Captures" class="rowlist"></div>
      </div>

      <div>
        <p><input type="checkbox" value="japanese" onchange="language()" /> Japanese Pieces</p>
      </div>

      <p class="warn">* Be warned, chats are visible to everyone!</p>
      <div class="chatarea">
        <div id="chats"></div>
        <textarea id="chatin"></textarea>
      </div>

    </div>


    <script>
      const p1cap = document.getElementById( 'player1Captures' );
      const p2cap = document.getElementById( 'player2Captures' );
      const name1 = document.getElementById( 'p1' );
      const name2 = document.getElementById( 'p2' );
      const name1cap = document.getElementById( 'p1capname' );
      const name2cap = document.getElementById( 'p2capname' );
      const chats = document.getElementById( 'chats' );
      const chatinput = document.getElementById( 'chatin' );

      const board = document.getElementById( 'board' );
      const rows = Array.prototype.filter.call( board.childNodes, i => {
        return i.className === 'shogi-row';
      })
      .map( r => {
        const cols = Array.prototype.filter.call( r.childNodes, i => {
          return i.className === 'shogi-square';
        });
        return cols;
      });

      let showJap = false;
      let player = '';
      let gameid = '';
      let samegame = false;
      let isplaying = false;
      let socket;
      let pieces = []

      const japChar = {
        L: '香', // 香車	
        LL: '杏', // 成香 this one is diff 
        N: '桂', // 桂馬
        NN: '圭', // 成桂 also diff
        S: '銀', // 銀將
        SS: '全', // 	成銀
        B: '角', // 角行
        BB: '馬', // 龍馬
        R: '飛', //'飛車'
        RR: '龍', // 龍王
        P: '歩', // 歩兵
        PP: 'と', // と金
        G: '金', // 金將
        GG: '金', 
        K: '王', // 王將
        KK: '王', 
      };

      chatinput.addEventListener( 'keydown', sendChat );

      function sendChat( ev ) {
        if ( ev.keyCode === 13 ) { // enter key
          ev.preventDefault();
          ev.stopPropagation();
          const text = chatinput.value;
          sendMessage({ chat: { player, text }})
          chatinput.value = '';
          chatinput.selectionStart = 0;
        }
      }
      

      function createPiece( p, allowupdown ) {
        const div = document.createElement( 'div' );
        div.id = p.id;
        div.innerText = showJap ? ( p.promoted ? japChar[`${p.name}${p.name}`]: japChar[p.name]) : p.name;
        div.classList.add( 'shogi-piece' );
        div.classList.add( p.size );
        const isOponent = p.owner === 'player2';
        isOponent && allowupdown && div.classList.add( 'upsidedown' );
        p.promoted && ( div.style.color = 'red');
        div.draggable = isplaying;
        div.addEventListener( 'dragstart', (ev) => {
          ev.dataTransfer.setData( 'text/plain', p.id );
          ev.dataTransfer.dropEffect = 'move';
        });
        div.addEventListener( 'mousedown', (ev) => {
          if ( !isplaying ) return;
          ev.shiftKey && (p.promoted = !p.promoted);
          div.style.color = p.promoted ? 'red' : 'black';
          div.innerText = showJap ? ( p.promoted ? japChar[`${p.name}${p.name}`]: japChar[p.name]) : p.name;
          sendMessage( { move: { moved: {...p} } });
        });
        return div;
      };

      function redraw( ) {
        clearBoard();

        pieces.forEach( p => {
          const div = createPiece( p, !p.captured );
          if ( !p.captured ) {
            const mom = rows[ p.y ][ p.x ];
            mom.appendChild( div );
          }
          else {
            if ( p.owner === 'player1') {
              p1cap.appendChild( div );
            }
            else {
              p2cap.appendChild( div );
            }
          }
        });

        const flipboard = isplaying && (player === 'player2');
        flipboard && board.classList.add( 'upsidedown');
      }

      // setup the drop squares
      rows.forEach( cols => {
        cols.forEach( square => {
          square.ondragover = (ev) => {
            ev.preventDefault();
            square.style.borderColor = 'green';
          };
          square.ondragleave = (ev) => {
            ev.preventDefault();
            square.style.borderColor = 'brown';
          };
          square.ondrop = (ev) => {
            ev.preventDefault();
            const data = {
              player,
            };
            const capturesPiece = /shogi-piece/.test( ev.target.className );
            if ( capturesPiece ) {
              const capture = ev.target;
              data.captureId = capture.id;
            }
            const id = ev.dataTransfer.getData( 'text/plain' );
            const movedData = pieces.find( i => i.id === id );
            movedData.x = parseInt( square.dataset.x );
            movedData.y = parseInt( square.dataset.y );
            movedData.captured = false;
            data.moved = movedData;

            square.style.borderColor = 'brown';

            sendMessage( { move: data });
          };
          
        });
      });

      window.onload = () => {
        const cookies = {}
        document.cookie.split(';').map( c => {
          const [key, val] = c.split('=');
          if ( /shogi-or-go-id/.test( key ) ) {
            cookies.gameid = val;
          }
          else if ( /shogi-or-go-is-player/.test( key ) ) {
            cookies.player = val;
          }
        });
        const ingame = window.location.pathname.split('/')[2];
        samegame = ingame === cookies.gameid;
        isplaying = samegame && cookies.player;
        if ( isplaying ) {
          player = cookies.player;
        }
        console.log( 'gameid', ingame, samegame ? 'playing':  'watching' );
        !isplaying && chatinput.classList.add( 'hide' );

        const wsProto = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsPort = window.location.port ? `:${window.location.port}` : '';
        const wsUrl = `${wsProto}://${window.location.hostname}${wsPort}/websocket/${ingame}`;
        socket = new WebSocket( wsUrl );
        socket.addEventListener('open', (ev) => {
          console.log('WebSocket open event:', ev);
        });
        socket.addEventListener('message', socketMessage);
        socket.addEventListener('error', genericError);

        redraw();
      };

      function socketMessage( m ) {
        const msg = JSON.parse(m.data);
        if ( msg.pieces ) {
          pieces = msg.pieces;
          redraw();
        }
        if ( msg.name1 ) {
          name1.innerText = msg.name1;
          name1cap.innerText = msg.name1;
        }
        if ( msg.name2 ) {
          name2.innerText = msg.name2;
          name2cap.innerText = msg.name2;
        }
        if ( msg.message ) {
          alert( msg.message );
        }
        if ( msg.chat ) {
          const p = document.createElement( 'p' );
          p.innerText = msg.chat.text;
          p.classList.add( msg.chat.player === 'player1' ? 'violet': 'teal' );
          chats.appendChild( p );
          p.scrollIntoView();
        }
      }

      function genericError( e ) {
        if ( e.isTrusted ) {
          console.log( e );
          alert( e );
        }
        else {
          console.log( e.message || e );
          alert( e.message || e );
        }
      }

      function clearBoard() {
        rows.forEach( cols => {
          cols.forEach( square => {
            square.innerText = "";
          });
        });
        p1cap.innerText = '';
        p2cap.innerText = '';
      }

      function language() {
        showJap = !showJap;
        redraw();
      }

      function sendMessage( data ) {
        const msg = JSON.stringify( data );
        if ( socket && socket.readyState === socket.OPEN) { 
          socket.send( msg );
        }
        else {
          alert( 'Failed - Socket Closed' );
        }
      }

    </script>
  </body>
</html>
